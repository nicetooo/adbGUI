# Gaze é¡¹ç›® Review

**è¯„åˆ†ï¼š6/10 - æœ‰æ½œåŠ›ä½†æœªå®Œæˆ**

**Review æ—¥æœŸ**: 2025-01-11

---

## ğŸ”´ ä¸¥é‡é—®é¢˜ (éœ€ç«‹å³ä¿®å¤)

### 1. é”™è¯¯å¤„ç†ç¼ºå¤±
**æ–‡ä»¶**: `app.go:679, 689, 731`

å¤šå¤„ `return nil, nil` é™é»˜å¤±è´¥ï¼Œå‰ç«¯æ— æ³•çŸ¥é“ä¸ºä»€ä¹ˆæ²¡æ•°æ®ã€‚

```go
// å½“å‰
if a.eventStore == nil {
    return nil, nil
}

// åº”è¯¥
return nil, fmt.Errorf("event store not initialized")
```

**ç›¸å…³æ–‡ä»¶**:
- `event_store.go:625, 957, 1425, 1606`

### 2. ç«æ€æ¡ä»¶
**æ–‡ä»¶**: `session_manager.go:345`

`eventPipeline` åœ¨ shutdown æ—¶å¯èƒ½ä¸º nilï¼Œæ²¡æœ‰åŒæ­¥ä¿æŠ¤ã€‚

```go
if a.eventPipeline != nil {
    a.bridgeToNewPipeline(event)  // eventPipeline å¯èƒ½åœ¨æ­¤æ—¶å˜ä¸º nil
}
```

### 3. é›¶æµ‹è¯•è¦†ç›–
- æ²¡æœ‰ä»»ä½• `*_test.go` æ–‡ä»¶
- äº‹ä»¶ç³»ç»Ÿã€æ•°æ®åº“æ“ä½œã€å¹¶å‘å¤„ç†éƒ½æ²¡æœ‰æµ‹è¯•
- å»ºè®®ä¼˜å…ˆä¸ºä»¥ä¸‹æ¨¡å—æ·»åŠ æµ‹è¯•ï¼š
  - `event_pipeline.go`
  - `event_assertion.go`
  - `event_store.go`

### 4. å‰ç«¯æ€§èƒ½é—®é¢˜
**æ–‡ä»¶**: `frontend/src/components/EventTimeline.tsx`

ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰äº‹ä»¶ï¼š
- åç«¯æ”¯æŒ 50,000+ äº‹ä»¶/session (`event_store.go:68`)
- å‰ç«¯æ²¡æœ‰åˆ†é¡µï¼Œå¤§æ•°æ®é‡ä¼šå¯¼è‡´å†…å­˜çˆ†ç‚¸å’Œæ¸²æŸ“å¡é¡¿

---

## ğŸŸ¡ é«˜ä¼˜å…ˆçº§ (v1.0 å‰ä¿®å¤)

| é—®é¢˜ | æ–‡ä»¶ | å½±å“ |
|------|------|------|
| ç¼“å­˜æ— é™å¢é•¿ | `event_pipeline.go:37-39` | å†…å­˜æ³„æ¼ |
| Channel æœªå…³é—­ | `automation.go:1427` | èµ„æºæ³„æ¼ |
| WebSocket æ”¯æŒç¦ç”¨ | `proxy/proxy.go:242` | åŠŸèƒ½ä¸å®Œæ•´ |
| TypeScript ç±»å‹ç¼ºå¤± | å¤šå¤„ `@ts-ignore` | ç±»å‹å®‰å…¨ç¼ºå¤± |
| åŒäº‹ä»¶ç³»ç»Ÿ | `event_pipeline` + `session_manager` | æ¶æ„æ··ä¹± |

### è¯¦ç»†è¯´æ˜

#### ç¼“å­˜æ— é™å¢é•¿
```go
// event_pipeline.go:37-39
frontendBuffer   []UnifiedEvent
timeIndexCache   map[string]map[int]*TimeIndexEntry
```
- æ²¡æœ‰é©±é€ç­–ç•¥
- é•¿æ—¶é—´è¿è¡Œä¼šå¯¼è‡´å†…å­˜æ³„æ¼

#### Channel æœªå…³é—­
```go
// automation.go:1427
taskPauseSignal[deviceId] = make(chan struct{})
// Channel åˆ›å»ºä½†åœ¨é”™è¯¯è·¯å¾„ä¸‹ä¸ä¿è¯æ¸…ç†
```

#### TypeScript ç±»å‹é—®é¢˜
```tsx
// App.tsx:56-62
// @ts-ignore
import { OpenPath, SetProxyDevice } from "../wailsjs/go/main/App";
// @ts-ignore
const BrowserOpenURL = (window as any).runtime.BrowserOpenURL;
```
å»ºè®®ï¼šä¸º Wails ç»‘å®šåˆ›å»ºæ­£ç¡®çš„ TypeScript å®šä¹‰ã€‚

---

## ğŸŸ¢ åŠŸèƒ½å®Œæˆåº¦

| åŠŸèƒ½ | çŠ¶æ€ | å®Œæˆåº¦ | å¤‡æ³¨ |
|------|------|--------|------|
| è®¾å¤‡ç®¡ç† | âœ… | 100% | USB + æ— çº¿ |
| æŠ•å±å½•åˆ¶ | âœ… | 100% | scrcpy é›†æˆ |
| æ–‡ä»¶ç®¡ç† | âœ… | 100% | æ‹–æ‹½ä¸Šä¼ ä¸‹è½½ |
| åº”ç”¨ç®¡ç† | âœ… | 100% | APK å®‰è£…/å¯¼å‡º/å¸è½½ |
| Shell | âœ… | 100% | äº¤äº’å¼ç»ˆç«¯ |
| Logcat | âœ… | 90% | ç¼ºå°‘å†…å­˜é™åˆ¶ |
| ç½‘ç»œä»£ç† | âœ… | 90% | ç¼ºå°‘å¯¼å‡º/è¯·æ±‚ä¿®æ”¹ |
| UI Inspector | ğŸŸ¡ | 80% | å…ƒç´ é€‰æ‹©å™¨å¯ç”¨ |
| Workflow | ğŸŸ¡ | 60% | åŸºç¡€å½•åˆ¶å›æ”¾å¯ç”¨ |
| Session ç®¡ç† | ğŸŸ¡ | 50% | æ—¶é—´çº¿ UI æœªå®Œæˆ |
| æ–­è¨€ç³»ç»Ÿ | ğŸŸ¡ | 60% | ç¼ºå°‘è°ƒè¯• UI |
| è®¾å¤‡ç›‘æ§ | ğŸŸ¡ | 40% | è§¦æ‘¸äº‹ä»¶æ•è·ä¸å®Œæ•´ |

---

## ğŸ› å·²çŸ¥ Bug

### 1. èµ„æºç®¡ç†é—®é¢˜
**æ–‡ä»¶**: `logcat.go:44-95`
- ç¼ºå°‘ context timeout
- æ— æœ€å¤§è¡Œç¼“å†²åŒºé™åˆ¶ï¼Œå¯èƒ½å¯¼è‡´å†…å­˜è€—å°½

### 2. æ•°æ®åº“è¿æ¥æœªéªŒè¯
**æ–‡ä»¶**: `event_store.go:239-240`
```go
db.SetMaxOpenConns(1)
db.SetMaxIdleConns(1)
// æ²¡æœ‰ ping() éªŒè¯è¿æ¥æ˜¯å¦æ­£å¸¸
```

### 3. ä¿¡å·å¤„ç†ä¸å®Œæ•´
**æ–‡ä»¶**: `main.go:43-51`
```go
go func() {
    sig := <-sigChan
    // ç›´æ¥ os.Exit(0)ï¼Œå¯èƒ½ä¸ç­‰å¾…æ¸…ç†å®Œæˆ
}()
```

### 4. System Tray Linux æ”¯æŒä¸å®Œæ•´
**æ–‡ä»¶**: `systray/systray_unix.go:46`
```go
// TODO handle the templateIconBytes?
```

---

## ğŸ“‹ å»ºè®®æ–°åŠŸèƒ½

### çŸ­æœŸ (æ˜“å®ç°)

1. **å‰ç«¯åˆ†é¡µ**
   - EventTimeline æ‡’åŠ è½½
   - åŸºäºæ¸¸æ ‡çš„åˆ†é¡µæŸ¥è¯¢

2. **æ–­è¨€æ¨¡æ¿åº“**
   - é¢„è®¾å¸¸ç”¨æ–­è¨€ï¼ˆæ— å´©æºƒã€å“åº”æ—¶é—´ã€äº‹ä»¶è®¡æ•°ç­‰ï¼‰
   - ç”¨æˆ·å¯ä¿å­˜è‡ªå®šä¹‰æ¨¡æ¿

3. **å¯¼å‡ºæŠ¥å‘Š**
   - Session åˆ†ææŠ¥å‘Šå¯¼å‡º (HTML/PDF)
   - åŒ…å«äº‹ä»¶ç»Ÿè®¡ã€æ–­è¨€ç»“æœã€æ—¶é—´çº¿æˆªå›¾

4. **å¿«æ·é”®**
   - å¸¸ç”¨æ“ä½œé”®ç›˜å¿«æ·é”®
   - å‚è€ƒ VS Code å¿«æ·é”®è®¾è®¡

### ä¸­æœŸ

1. **è§†é¢‘åŒæ­¥**
   - å½•å±ä¸äº‹ä»¶æ—¶é—´çº¿åŒæ­¥æ’­æ”¾
   - ç‚¹å‡»äº‹ä»¶è·³è½¬åˆ°å¯¹åº”è§†é¢‘æ—¶é—´ç‚¹

2. **æ–­è¨€å¤±è´¥è°ƒè¯•**
   - ç‚¹å‡»å¤±è´¥æ–­è¨€è·³è½¬åˆ°å¯¹åº”äº‹ä»¶
   - æ˜¾ç¤ºæ–­è¨€å¤±è´¥åŸå› å’Œä¸Šä¸‹æ–‡

3. **æ€§èƒ½åˆ†æ**
   - CPU/å†…å­˜/å¸§ç‡ç›‘æ§
   - æ€§èƒ½ç“¶é¢ˆè‡ªåŠ¨è¯†åˆ«

4. **å¤šè®¾å¤‡å¯¹æ¯”**
   - è·¨è®¾å¤‡ session å¯¹æ¯”
   - åŒä¸€æ“ä½œåœ¨ä¸åŒè®¾å¤‡ä¸Šçš„è¡¨ç°å·®å¼‚

### é•¿æœŸ (å·®å¼‚åŒ–åŠŸèƒ½)

1. **AI æ–­è¨€ç”Ÿæˆ**
   - åŸºäºå†å²æ•°æ®è‡ªåŠ¨ç”Ÿæˆæ–­è¨€
   - å¼‚å¸¸æ£€æµ‹å’Œå»ºè®®

2. **CI/CD é›†æˆ**
   - å‘½ä»¤è¡Œæ¨¡å¼è¿è¡Œæµ‹è¯•
   - æ”¯æŒ GitHub Actions / Jenkins

3. **äº‘ç«¯åŒæ­¥**
   - Session æ•°æ®äº‘ç«¯å¤‡ä»½
   - å›¢é˜Ÿåä½œå…±äº«

4. **æ’ä»¶ç³»ç»Ÿ**
   - è‡ªå®šä¹‰äº‹ä»¶æº
   - è‡ªå®šä¹‰æ–­è¨€ç±»å‹
   - ç¬¬ä¸‰æ–¹å·¥å…·é›†æˆ

---

## ğŸ—ï¸ æ¶æ„æ”¹è¿›å»ºè®®

### å½“å‰é—®é¢˜
`App` struct æœ‰ 24+ å­—æ®µï¼ŒèŒè´£è¿‡å¤šï¼š
- è®¾å¤‡ç®¡ç†
- Session è·Ÿè¸ª
- äº‹ä»¶å¤„ç†
- äºŒè¿›åˆ¶æ–‡ä»¶è®¾ç½®
- ä»£ç†ç®¡ç†
- æ— çº¿è¿æ¥
- è®¾å¤‡ç›‘æ§
- è¿è¡Œæ—¶æ—¥å¿—

### å»ºè®®æ‹†åˆ†

```
pkg/
â”œâ”€â”€ devices/      # è®¾å¤‡ç®¡ç†
â”‚   â”œâ”€â”€ device.go
â”‚   â”œâ”€â”€ wireless.go
â”‚   â””â”€â”€ monitor.go
â”œâ”€â”€ session/      # ä¼šè¯ç”Ÿå‘½å‘¨æœŸ
â”‚   â”œâ”€â”€ manager.go
â”‚   â”œâ”€â”€ events.go
â”‚   â””â”€â”€ storage.go
â”œâ”€â”€ events/       # äº‹ä»¶ç³»ç»Ÿ
â”‚   â”œâ”€â”€ pipeline.go
â”‚   â”œâ”€â”€ store.go
â”‚   â””â”€â”€ assertion.go
â”œâ”€â”€ proxy/        # ç½‘ç»œä»£ç† (å·²åˆ†ç¦»)
â”œâ”€â”€ automation/   # è‡ªåŠ¨åŒ–
â”‚   â”œâ”€â”€ workflow.go
â”‚   â””â”€â”€ recorder.go
â””â”€â”€ storage/      # SQLite æ“ä½œ
    â””â”€â”€ sqlite.go
```

### åŒäº‹ä»¶ç³»ç»Ÿç»Ÿä¸€

å½“å‰å­˜åœ¨ä¸¤å¥—äº‹ä»¶ç³»ç»Ÿï¼š
1. `SessionEvent` (å†…å­˜) - `session_manager.go`
2. `UnifiedEvent` (SQLite) - `event_pipeline.go`

å»ºè®®ï¼š
- ç»Ÿä¸€ä¸º `UnifiedEvent`
- ç§»é™¤ `SessionEvent` æ¡¥æ¥ä»£ç 
- å‡å°‘äº‹ä»¶è½¬æ¢å¼€é”€

---

## ğŸ“Š ä¸ç«å“å¯¹æ¯”

| åŠŸèƒ½ | Gaze | scrcpy-gui | QtScrcpy |
|------|------|-----------|----------|
| æŠ•å± | âœ“ | âœ“ | âœ“ |
| å½•åˆ¶ | âœ“ | âœ“ | âœ“ |
| å¤šè®¾å¤‡ | âœ“ | âœ“ | âœ“ |
| Session æ—¶é—´çº¿ | âœ“ (æ–°) | âœ— | âœ— |
| äº‹ä»¶æ–­è¨€ | âœ“ (æ–°) | âœ— | âœ— |
| ç½‘ç»œæŠ“åŒ… | âœ“ | âœ— | âœ— |
| Logcat èšåˆ | âœ“ | âœ“ | âœ“ |
| UI Inspector | âœ“ | âœ“ | âœ“ |
| è‡ªåŠ¨åŒ– | âœ“ | âœ— | âœ“ |
| æŒä¹…åŒ–å­˜å‚¨ | âœ“ (æ–°) | âœ— | âœ— |
| æ·±è‰²æ¨¡å¼ | âœ“ | âœ“ | âœ“ |

### Gaze çš„ç‹¬ç‰¹ä»·å€¼
- å”¯ä¸€ç»“åˆ scrcpy + session æ—¶é—´çº¿ + äº‹ä»¶æ–­è¨€çš„å·¥å…·
- ç½‘ç»œä»£ç†é›†æˆå¢åŠ è°ƒè¯•èƒ½åŠ›
- ä¸€æ—¦æ–­è¨€ç³»ç»Ÿæˆç†Ÿï¼Œå¯ç”¨äºè‡ªåŠ¨åŒ–æµ‹è¯•

### åŠ£åŠ¿
- äº‹ä»¶ç³»ç»Ÿæœªå®Œæˆ
- ç¨³å®šæ€§ä¸å¦‚ scrcpy-gui
- æ¯” QtScrcpy æ›´é‡ï¼ˆWails ä¾èµ–ï¼‰

---

## âœ… ä¿®å¤ä¼˜å…ˆçº§

### P0 - å‘å¸ƒå‰å¿…é¡»ä¿®å¤
- [ ] å®ç°æ­£ç¡®çš„é”™è¯¯ä¼ æ’­ï¼ˆapp.go é™é»˜å¤±è´¥ï¼‰
- [ ] ä¿®å¤ shutdown ç«æ€æ¡ä»¶
- [ ] æ·»åŠ äº‹ä»¶ç³»ç»Ÿæµ‹è¯•
- [ ] å‰ç«¯åˆ†é¡µï¼ˆå¤§ session æ”¯æŒï¼‰

### P1 - v1.0 å‰
- [ ] ç¼“å­˜é©±é€ç­–ç•¥
- [ ] å®Œæˆè®¾å¤‡ç›‘æ§æ¸…ç†é€»è¾‘
- [ ] å®ç° WebSocket æ”¯æŒ
- [ ] æ–­è¨€æ¨¡æ¿åº“
- [ ] API æ–‡æ¡£

### P2 - åç»­ç‰ˆæœ¬
- [ ] TypeScript ç±»å‹å®Œå–„
- [ ] é‡æ„ App struct
- [ ] æ·»åŠ  goroutine è·Ÿè¸ª
- [ ] ç»“æ„åŒ–æ—¥å¿—
- [ ] Linux system tray å›¾æ ‡
- [ ] æ‰¹é‡ SQL ä¼˜åŒ–
- [ ] æ€§èƒ½åˆ†æäº‹ä»¶æ”¶é›†
- [ ] è·¨è®¾å¤‡ session å…³è”

---

## ğŸ“ å¤‡æ³¨

- ä»£ç æ³¨é‡Šä¸»è¦ä¸ºä¸­æ–‡ï¼ˆåˆ©äºç»´æŠ¤è€…ï¼Œä½†å½±å“å¼€æºè´¡çŒ®ï¼‰
- æ—  API æ–‡æ¡£æˆ–è®¾è®¡è§„èŒƒ
- å»ºè®®æ·»åŠ  CONTRIBUTING.md æŒ‡å—
